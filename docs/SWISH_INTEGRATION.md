# Swish Integration Implementation Guide

## Current Status

The checkout endpoint (`/v1/checkout`) is implemented with **mock Swish payments**. To enable real Swish payments, follow this guide.

## Swish Merchant Information

- **Merchant Number:** 1236166490
- **Environment:** Currently set to `test`, needs to be switched to `production`

## Required Setup

### 1. Swish Certificates

Swish uses mutual TLS (mTLS) for authentication. You need:

1. **Client Certificate (.pem)** - Identifies your application to Swish
2. **Private Key (.key)** - Paired with the certificate
3. **CA Certificate** - Swish's certificate authority chain
4. **Certificate Passphrase** - If your private key is encrypted

**How to obtain:**
- Log in to Swish merchant portal
- Navigate to "API Certificates" or "Technical Settings"
- Download or generate your certificates
- Store them securely (recommended: AWS Secrets Manager)

### 2. Environment Variables

Add these to your Lambda environment variables (via CDK or AWS Console):

```bash
# Production settings
SWISH_ENVIRONMENT=production
SWISH_MERCHANT_NUMBER=1236166490
SWISH_CALLBACK_URL=https://smultron.zwc.se/v1/swish/callback

# Certificate paths (if storing in Lambda layer or S3)
SWISH_CERT_PATH=/opt/certificates/swish-client.pem
SWISH_KEY_PATH=/opt/certificates/swish-client.key
SWISH_CA_CERT_PATH=/opt/certificates/swish-ca.pem
SWISH_PASSPHRASE=your-certificate-passphrase

# Or use AWS Secrets Manager ARN
SWISH_CERT_SECRET_ARN=arn:aws:secretsmanager:region:account:secret:swish-certs
```

## Swish API Endpoints

**Important:** Swish uses **PUT** requests with a UUID in the URL, not POST.

**Production:**
- Base URL: `https://cpc.getswish.net/swish-cpcapi/api/v2`
- Payment Requests: `PUT /paymentrequests/{uuid}`
- Payment Status: `GET /paymentrequests/{uuid}`
- Refunds: `POST /refunds`

**Test (MSS - Merchant Swish Simulator):**
- Base URL: `https://mss.cpc.getswish.net/swish-cpcapi/api/v2`
- Same endpoints as production
- Use test certificates
- Test phone numbers: `46701234768` - `46701234769`

## Implementation Steps

### Key Points from Swish Documentation

1. **PUT, not POST**: Payment requests use `PUT /paymentrequests/{uuid}`, where the UUID is generated by you
2. **Amount is a string**: The `amount` field must be a string, not a number
3. **Phone number format**: Phone numbers should be in format `46XXXXXXXXX` (no spaces, dashes, or leading zero)
4. **mTLS required**: All requests require mutual TLS with client certificates
5. **E-commerce vs M-commerce**: 
   - E-commerce: Omit `payerAlias`, customer enters number in Swish app
   - M-commerce: Include `payerAlias` with pre-filled phone number

### Step 1: Store Certificates Securely

**Option A: AWS Secrets Manager (Recommended)**

```typescript
import { SecretsManagerClient, GetSecretValueCommand } from '@aws-sdk/client-secrets-manager';

async function getSwishCertificates() {
  const client = new SecretsManagerClient({ region: 'eu-north-1' });
  const response = await client.send(
    new GetSecretValueCommand({
      SecretId: process.env.SWISH_CERT_SECRET_ARN,
    })
  );
  
  const secrets = JSON.parse(response.SecretString!);
  return {
    cert: secrets.certificate,
    key: secrets.privateKey,
    ca: secrets.caCertificate,
    passphrase: secrets.passphrase,
  };
}
```

**Option B: Lambda Layer**

1. Create a Lambda layer with certificates
2. Mount at `/opt/certificates`
3. Reference via environment variables

### Step 2: Update Swish Service

Replace the mock implementation in `src/services/swish.ts`:

```typescript
const fs = require('fs');
const https = require('https');
const axios = require('axios');

// Cache certificates to avoid repeated file reads
let cachedAgent: https.Agent | null = null;

function getHttpsAgent() {
  if (cachedAgent) {
    return cachedAgent;
  }

  cachedAgent = new https.Agent({
    cert: fs.readFileSync(process.env.SWISH_CERT_PATH!, { encoding: 'utf8' }),
    key: fs.readFileSync(process.env.SWISH_KEY_PATH!, { encoding: 'utf8' }),
    ca: fs.readFileSync(process.env.SWISH_CA_CERT_PATH!, { encoding: 'utf8' }),
  });

  return cachedAgent;
}

export async function createSwishPayment(
  orderNumber: string,
  amount: number,
  phoneNumber?: string,
  message?: string
): Promise<{ id: string; location: string; status: string }> {
  
  // Generate UUID for the payment request (instruction ID)
  const instructionId = crypto.randomUUID();

  // Clean phone number if provided
  let cleanPhone: string | undefined;
  if (phoneNumber) {
    cleanPhone = phoneNumber.replace(/[^0-9]/g, '');
    if (cleanPhone.startsWith('0')) {
      cleanPhone = '46' + cleanPhone.substring(1);
    }
    if (!cleanPhone.startsWith('46')) {
      cleanPhone = '46' + cleanPhone;
    }
  }

  const paymentRequest = {
    payeePaymentReference: orderNumber,
    callbackUrl: SWISH_CALLBACK_URL,
    payeeAlias: SWISH_MERCHANT_NUMBER,
    currency: 'SEK',
    amount: amount.toString(), // Must be string
    message: message || `Order ${orderNumber}`,
    ...(cleanPhone && { payerAlias: cleanPhone }), // Only include if provided
  };

  try {
    const agent = getHttpsAgent();
    const client = axios.create({ httpsAgent: agent });

    // Swish uses PUT with UUID in URL, not POST
    await client.put(
      `${SWISH_API_BASE_URL}/paymentrequests/${instructionId}`,
      paymentRequest
    );

    return {
      id: instructionId,
      location: `${SWISH_API_BASE_URL}/paymentrequests/${instructionId}`,
      status: 'CREATED',
    };
  } catch (error) {
    console.error('Swish payment creation failed:', error);
    throw error;
  }
}
```

### Step 3: Create Swish Callback Handler

Create `src/handlers/swish.callback.ts`:

```typescript
import type { APIGatewayProxyEvent } from 'aws-lambda';
import type { APIResponse } from '../types';
import { successResponse, errorResponse } from '../utils/response';
import { getOrder, updateOrderStatus } from '../services/product';

export const method = 'POST';
export const route = '/swish/callback';

export const handler = async (event: APIGatewayProxyEvent): Promise<APIResponse> => {
  try {
    if (!event.body) {
      return errorResponse('Request body is required', 400);
    }

    const callback = JSON.parse(event.body);
    
    console.log('Swish callback received:', callback);

    const { id, payeePaymentReference, status, errorCode, errorMessage } = callback;

    // Extract order number from payment reference
    const orderNumber = payeePaymentReference;

    // TODO: Get order by number (need to add method)
    // const order = await getOrderByNumber(orderNumber);

    switch (status) {
      case 'PAID':
        console.log(`Payment successful for order ${orderNumber}`);
        // Update order status to confirmed/paid
        // await updateOrderPaymentStatus(order.id, 'paid');
        // Send confirmation email
        break;

      case 'DECLINED':
      case 'ERROR':
      case 'CANCELLED':
        console.log(`Payment failed for order ${orderNumber}: ${status}`, errorMessage);
        // Update order status
        // Restore stock if needed
        // await cancelOrder(order.id);
        break;

      default:
        console.log(`Unknown payment status: ${status}`);
    }

    // Always return 200 to acknowledge callback
    return successResponse({ received: true });
  } catch (error) {
    console.error('Swish callback error:', error);
    // Return 200 even on error to prevent Swish from retrying
    return successResponse({ received: true });
  }
};
```

### Step 4: Add Callback Route to CDK

In `infrastructure/lib/smultron-stack.ts`:

```typescript
const swishCallbackFunction = new lambda.Function(this, 'SwishCallbackFunction', {
  ...commonLambdaProps,
  functionName: `smultron-swish-callback-${environment}`,
  code: lambdaCode,
  handler: 'index.swishCallback',
});
ordersTable.grantReadWriteData(swishCallbackFunction);
productsTable.grantReadWriteData(swishCallbackFunction);

// Add route
const swish = v1.addResource('swish');
const swishCallback = swish.addResource('callback');
swishCallback.addMethod('POST', new apigateway.LambdaIntegration(swishCallbackFunction));
```

### Step 5: Grant Secrets Manager Access

Update CDK stack to grant Lambda access to Secrets Manager:

```typescript
// Add to common Lambda props
const secretsPolicy = new iam.PolicyStatement({
  actions: ['secretsmanager:GetSecretValue'],
  resources: [`arn:aws:secretsmanager:${this.region}:${this.account}:secret:swish-*`],
});

checkoutFunction.addToRolePolicy(secretsPolicy);
```

## Testing

### Test Environment (MSS)

1. Use test merchant number: `1234679304`
2. Test phone numbers: `46701234567` - `46701234569`
3. Base URL: `https://mss.cpc.getswish.net/swish-cpcapi/api/v2`

### Production

1. Set `SWISH_ENVIRONMENT=production`
2. Use real merchant number: `1236166490`
3. Use real phone numbers
4. Base URL: `https://cpc.getswish.net/swish-cpcapi/api/v2`

## Payment Flow

1. **Customer submits checkout** → `/v1/checkout`
2. **System creates order** and initiates Swish payment
3. **Swish returns payment ID** and location
4. **Customer opens Swish app** (redirect to swish:// deep link on mobile)
5. **Customer approves payment** in Swish app
6. **Swish sends callback** → `/v1/swish/callback`
7. **System updates order status** based on callback

## Error Handling

Common Swish errors:

- `RF07` - Transaction declined
- `ACMT03` - Payer not enrolled
- `ACMT07` - Payer's account blocked
- `AM06` - Amount too low/high
- `BANKIDCL` - BankID cancelled

Handle these in your callback handler and provide appropriate user feedback.

## Security Checklist

- [ ] Certificates stored in AWS Secrets Manager
- [ ] Secrets Manager access restricted to Lambda execution role
- [ ] Callback endpoint validates Swish IP addresses (optional)
- [ ] HTTPS only for callback URL
- [ ] Certificate rotation process documented
- [ ] Monitoring and alerting for payment failures

## Next Steps

1. Obtain Swish certificates from merchant portal
2. Store in AWS Secrets Manager
3. Update CDK stack with Secrets Manager permissions
4. Implement callback handler
5. Test in MSS environment
6. Deploy to production

## Support

- **Swish Support:** support@getswish.se
- **Technical Documentation:** https://developer.swish.nu/
- **Merchant Portal:** https://portal.swish.nu/
